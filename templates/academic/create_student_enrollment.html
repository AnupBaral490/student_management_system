{% extends 'base.html' %}

{% block title %}{{ title }} - SMS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-user-plus"></i> {{ title }}</h2>
            <a href="{% url 'academic:manage_student_enrollment' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Enrollments
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-form"></i> Enrollment Details</h6>
            </div>
            <div class="card-body">
                <form method="post" id="enrollmentForm">
                    {% csrf_token %}
                    
                    <!-- Student Selection -->
                    <div class="mb-3">
                        <label for="{{ form.student.id_for_label }}" class="form-label">
                            <i class="fas fa-user"></i> Student *
                        </label>
                        {{ form.student }}
                        {% if form.student.help_text %}
                            <div class="form-text">{{ form.student.help_text }}</div>
                        {% endif %}
                        {% if form.student.errors %}
                            <div class="text-danger">
                                {% for error in form.student.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Department Selection -->
                    <div class="mb-3">
                        <label for="{{ form.department.id_for_label }}" class="form-label">
                            <i class="fas fa-building"></i> Department *
                        </label>
                        {{ form.department }}
                        {% if form.department.help_text %}
                            <div class="form-text">{{ form.department.help_text }}</div>
                        {% endif %}
                        {% if form.department.errors %}
                            <div class="text-danger">
                                {% for error in form.department.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Course Selection -->
                    <div class="mb-3">
                        <label for="{{ form.course.id_for_label }}" class="form-label">
                            <i class="fas fa-graduation-cap"></i> Course *
                        </label>
                        {{ form.course }}
                        {% if form.course.help_text %}
                            <div class="form-text">{{ form.course.help_text }}</div>
                        {% endif %}
                        {% if form.course.errors %}
                            <div class="text-danger">
                                {% for error in form.course.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Class Selection -->
                    <div class="mb-3">
                        <label for="{{ form.class_enrolled.id_for_label }}" class="form-label">
                            <i class="fas fa-users"></i> Class *
                        </label>
                        {{ form.class_enrolled }}
                        {% if form.class_enrolled.help_text %}
                            <div class="form-text">Select the specific class (year, semester, section) for enrollment</div>
                        {% endif %}
                        {% if form.class_enrolled.errors %}
                            <div class="text-danger">
                                {% for error in form.class_enrolled.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Active Status -->
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_active }}
                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                <i class="fas fa-check-circle"></i> Active Enrollment
                            </label>
                        </div>
                        {% if form.is_active.help_text %}
                            <div class="form-text">{{ form.is_active.help_text }}</div>
                        {% endif %}
                        {% if form.is_active.errors %}
                            <div class="text-danger">
                                {% for error in form.is_active.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'academic:manage_student_enrollment' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Enrollment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Help Card -->
        <div class="card">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-info-circle"></i> Enrollment Guide</h6>
            </div>
            <div class="card-body">
                <h6>Steps to Enroll a Student:</h6>
                <ol class="small">
                    <li><strong>Select Student:</strong> Choose the student to enroll</li>
                    <li><strong>Choose Department:</strong> Select the department first</li>
                    <li><strong>Select Course:</strong> Choose from courses in the selected department</li>
                    <li><strong>Pick Class:</strong> Select the specific class (year, semester, section)</li>
                    <li><strong>Set Status:</strong> Mark as active for current enrollment</li>
                </ol>
                
                <hr>
                
                <h6>Important Notes:</h6>
                <ul class="small">
                    <li>Students can only be enrolled in one active class at a time</li>
                    <li>Department and course selection will filter available classes</li>
                    <li>Inactive enrollments are kept for historical records</li>
                    <li>Class teacher and academic year are automatically assigned</li>
                </ul>
            </div>
        </div>

        <!-- Current Enrollments (if editing) -->
        {% if enrollment %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-history"></i> Current Enrollment</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Student:</strong> {{ enrollment.student.user.get_full_name }}
                </div>
                <div class="mb-2">
                    <strong>Current Class:</strong> {{ enrollment.class_enrolled }}
                </div>
                <div class="mb-2">
                    <strong>Enrolled:</strong> {{ enrollment.enrollment_date|date:"M d, Y" }}
                </div>
                <div class="mb-2">
                    <strong>Status:</strong> 
                    {% if enrollment.is_active %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('id_department');
    const courseSelect = document.getElementById('id_course');
    const classSelect = document.getElementById('id_class_enrolled');
    
    // Department change handler
    departmentSelect.addEventListener('change', function() {
        const departmentId = this.value;
        
        // Clear course and class options
        courseSelect.innerHTML = '<option value="">Select Course</option>';
        classSelect.innerHTML = '<option value="">Select Class</option>';
        
        if (departmentId) {
            // Fetch courses for selected department
            fetch(`{% url 'academic:api_courses_by_department' %}?department=${departmentId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = `${course.name} (${course.code})`;
                        courseSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching courses:', error);
                    // Fallback: populate from template data
                    {% for course in courses %}
                        if ({{ course.department.id }} == departmentId) {
                            const option = document.createElement('option');
                            option.value = {{ course.id }};
                            option.textContent = '{{ course.name }} ({{ course.code }})';
                            courseSelect.appendChild(option);
                        }
                    {% endfor %}
                });
        }
    });
    
    // Course change handler
    courseSelect.addEventListener('change', function() {
        const courseId = this.value;
        
        // Clear class options
        classSelect.innerHTML = '<option value="">Select Class</option>';
        
        if (courseId) {
            // Fetch classes for selected course
            fetch(`{% url 'academic:api_classes_by_course' %}?course=${courseId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(classObj => {
                        const option = document.createElement('option');
                        option.value = classObj.id;
                        option.textContent = classObj.display_name;
                        classSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching classes:', error);
                    // Fallback: populate from template data
                    {% for class in classes %}
                        if ({{ class.course.id }} == courseId) {
                            const option = document.createElement('option');
                            option.value = {{ class.id }};
                            option.textContent = 'Year {{ class.year }}, Sem {{ class.semester }} - {{ class.section }} ({{ class.academic_year.year }})';
                            classSelect.appendChild(option);
                        }
                    {% endfor %}
                });
        }
    });
    
    // Initialize form if editing
    {% if enrollment %}
        // Trigger department change to populate courses
        departmentSelect.dispatchEvent(new Event('change'));
        
        // Set initial values after a short delay
        setTimeout(() => {
            courseSelect.value = {{ enrollment.class_enrolled.course.id }};
            courseSelect.dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                classSelect.value = {{ enrollment.class_enrolled.id }};
            }, 100);
        }, 100);
    {% endif %}
});
</script>
{% endblock %}