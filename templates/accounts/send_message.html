{% extends 'base.html' %}

{% block title %}Send Message - SMS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-envelope"></i> Send Message to Teacher</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'accounts:contact_teachers' %}">Contact Teachers</a></li>
                <li class="breadcrumb-item active">Send Message</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="m-0"><i class="fas fa-paper-plane me-2"></i> Compose Message</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="student_id" class="form-label">About Child <span class="text-danger">*</span></label>
                        <select name="student_id" id="student_id" class="form-select" required onchange="loadTeachers(this.value)">
                            <option value="">Select a child</option>
                            {% for child in children %}
                            <option value="{{ child.id }}" {% if student and student.id == child.id %}selected{% endif %}>
                                {{ child.user.get_full_name }} ({{ child.student_id }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="teacher_id" class="form-label">To Teacher <span class="text-danger">*</span></label>
                        <select name="teacher_id" id="teacher_id" class="form-select" required>
                            <option value="">Select a teacher</option>
                            {% if teacher %}
                            <option value="{{ teacher.id }}" selected>
                                {% if teacher.user.first_name or teacher.user.last_name %}
                                    {{ teacher.user.get_full_name }}
                                {% else %}
                                    {{ teacher.user.username }}
                                {% endif %}
                            </option>
                            {% endif %}
                            {% for teacher_data in teachers %}
                            <option value="{{ teacher_data.teacher.id }}">
                                {% if teacher_data.teacher.user.first_name or teacher_data.teacher.user.last_name %}
                                    {{ teacher_data.teacher.user.get_full_name }}
                                {% else %}
                                    {{ teacher_data.teacher.user.username }}
                                {% endif %}
                                {% if teacher_data.subjects %} - {% for subject in teacher_data.subjects %}{{ subject.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        {% if student and not teachers and not teacher %}
                        <small class="text-muted">No teachers found for this child's class. Please contact the administrator.</small>
                        {% elif not student %}
                        <small class="text-muted">Please select a child first to see their teachers.</small>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject <span class="text-danger">*</span></label>
                        <input type="text" name="subject" id="subject" class="form-control" required placeholder="Enter message subject">
                    </div>
                    
                    <div class="mb-3">
                        <label for="message" class="form-label">Message <span class="text-danger">*</span></label>
                        <textarea name="message" id="message" class="form-control" rows="6" required placeholder="Type your message here..."></textarea>
                        <small class="text-muted">Be clear and respectful in your message.</small>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i> Send Message
                        </button>
                        <a href="{% url 'accounts:contact_teachers' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function loadTeachers(studentId) {
    if (!studentId) {
        document.getElementById('teacher_id').innerHTML = '<option value="">Select a teacher</option>';
        return;
    }
    
    // Show loading state
    const teacherSelect = document.getElementById('teacher_id');
    teacherSelect.innerHTML = '<option value="">Loading teachers...</option>';
    teacherSelect.disabled = true;
    
    // Reload page with student parameter
    window.location.href = '{% url "accounts:send_message" %}?student_id=' + studentId;
}
</script>

{% endblock %}
